<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Desktop Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;600&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 250px;
            --bg-primary: #2d1b4e; /* Tím đậm */
            --bg-secondary: #1c1035; /* Tím than */
            --bg-card: rgba(255, 255, 255, 0.1); /* Trong suốt */
            --text-light: #ffff;
            --text-secondary: #d1c4e9; /* Tím nhạt */
            --border-color: rgb(255, 99, 203);
            --table-bg: rgba(0, 0, 0, 0.2);
            --input-bg: rgba(255, 255, 255, 0.05);
            --neon-color: #00f3ff;
        }
        .btn-primary {
            background-color: transparent !important;
            border: 1px solid var(--neon-color) !important;
            color: var(--neon-color) !important;
            box-shadow: 0 0 10px var(--neon-color);
            transition: 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--neon-color) !important;
            color: #000 !important;
            box-shadow: 0 0 20px var(--neon-color), 0 0 40px var(--neon-color);
        }
        .card {
            border: 1px solid rgba(0, 243, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }
        .sidebar {
            border-right: 1px solid var(--neon-color);
            box-shadow: 2px 0 10px rgba(0, 243, 255, 0.1);
        }
        ::-webkit-scrollbar {
            width: 8px; 
        }

        ::-webkit-scrollbar-track {
            background: #0b111a; 
        }

        ::-webkit-scrollbar-thumb {
            background: #2a3a4d; 
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-color);
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background-color: #0b111a;
        }
        body {
            background-color: transparent !important; 
            color: var(--text-light);
            min-height: 100vh;
            font-family: 'Fira Code', monospace;
            overflow-x: hidden;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        h1, h2, h3, h4, h5, .navbar-brand {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        /* Navbar */
        .navbar {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            width: 100%;
            height: 56px;
            z-index: 1030;
            padding-left: var(--sidebar-width);
        }
        .navbar .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--text-light);
            margin-left: -15px;
        }
        .navbar .fa-bell, .navbar .fa-cog, .navbar .fa-user-circle {
            color: var(--text-secondary);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-height: 100vh;
            background-color: var(--bg-secondary);
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 56px;
            z-index: 1020;
            border-right: 1px solid var(--border-color);
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 15px 20px;
            transition: all 0.2s ease;
            font-size: 1.1rem;
            border-left: 5px solid transparent; 
            display: flex; 
            align-items: center;
        }

        .sidebar .nav-link i {
            width: 20px;
            text-align: center;
            margin-right: 15px;
            font-size: 1.1rem;
            color: var(--text-secondary); 
        }

        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background-color: var(--bg-card);
            color: var(--text-light);
        }
        
        .sidebar .nav-link.active {
            border-left-color: #007bff;
            font-weight: 600;
        }
        .sidebar .nav-link.active i {
            color: var(--text-light);
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            padding-top: 80px; 
            min-height: 100vh;
        }

        /* Card và Form Controls */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            box-shadow: none;
        }
        
        .form-control, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-light);
        }
        .form-control::placeholder { color: #6c757d; }

        /* Bảng Applications */
        .table-application {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px; 
            background-color: var(--table-bg); 
            border-radius: 8px; 
            margin-top: 15px;
        }

        .table-application thead th {
            background-color: var(--table-bg); 
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 15px 20px; 
            text-transform: uppercase;
            font-weight: 500;
            border-bottom: none; 
        }
        .table-application thead th:first-child { border-top-left-radius: 8px; }
        .table-application thead th:last-child { border-top-right-radius: 8px; }

        .table-application tbody tr {
            background-color: var(--bg-card); 
            color: var(--text-light); 
            border-radius: 8px;
            overflow: hidden;
            transition: background-color 0.2s;
        }
        .table-application tbody tr:hover { background-color: #274059; }
        .table-application tbody td {
            border-top: none;
            border-bottom: none;
            padding: 15px 20px; 
            vertical-align: middle;
        }
        .table-application tbody tr td:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .table-application tbody tr td:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            width: 80px;
        }
        
        .app-icon-box {
            width: 35px;
            height: 35px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background-color: #2a3a4d; 
            color: var(--text-light);
            font-size: 1.1rem;
            border-radius: 6px;
            margin-right: 15px;
        }

        .running-badge { background-color: #2ecc71 !important; }
        .notresp-badge { background-color: #f1c40f !important; color: #000 !important; }

        .btn-kill-app {
            color: #dc3545; 
            background: transparent;
            border: none;
            font-size: 1.3rem;
            padding: 0;
            transition: color 0.2s;
        }
        
        .pagination .page-item .page-link {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        .pagination .page-item.active .page-link {
            background-color: #007bff; 
            border-color: #007bff;
            color: var(--text-light);
        }
        
        .log-output-box {
            background-color: var(--bg-secondary);
            border: 1px solid #2a3a4d;
            height: 300px;
            overflow-y: auto;
            border-radius: .5rem;
            color: var(--text-secondary);
        }
        .log-output-box p {
            margin-bottom: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
        }
        .log-output-box .text-danger { color: #dc3545 !important; }
        .log-output-box .text-primary { color: #007bff !important; }
        
        .screenshot-placeholder {
            border: 2px dashed #2a3a4d;
            padding: 50px;
            border-radius: 8px;
            background-color: #16202d;
        }

        .video-container {
            background-color: #000;
            aspect-ratio: 16 / 9; 
            border: 1px solid #2a3a4d;
            border-radius: .5rem;
        }
        
        .power-btn { transition: transform 0.1s; }
        .power-btn:hover { transform: scale(1.02); }
        .cursor-pointer { cursor: pointer; }
        .btn-success {
            background-color: transparent !important;
            border: 1px solid #00ff41 !important; 
            color: #00ff41 !important;
            box-shadow: 0 0 10px #00ff41;
            transition: 0.3s;
        }
        .btn-success:hover {
            background-color: #00ff41 !important;
            color: #000 !important;
            box-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41;
        }

        .btn-info {
            background-color: transparent !important;
            border: 1px solid #00d8ff !important;
            color: #00d8ff !important;
            box-shadow: 0 0 10px #00d8ff;
            transition: 0.3s;
        }
        .btn-info:hover {
            background-color: #00d8ff !important;
            color: #000 !important;
            box-shadow: 0 0 20px #00d8ff, 0 0 40px #00d8ff;
        }
        input[type="file"] {
            color: var(--text-light);
            background-color: rgba(0, 0, 0, 0.2);
        }

        input[type="file"]::file-selector-button {
            background-color: transparent !important;
            color: var(--text-secondary) !important;
            padding: 8px 16px;
            margin-right: 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        #stop-logging-btn, #record-btn {
            background-color: transparent !important; 
            border: 1px solid #ff3333 !important;    
            color: #ff3333 !important;                
            box-shadow: 0 0 8px #ff3333;      
            transition: all 0.3s ease;
        }
        #stop-logging-btn:hover, #record-btn:hover {
            background-color: #ff3333 !important;
            color: #000 !important;
            box-shadow: 0 0 20px #ff3333, 0 0 40px #ff3333;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<div id="particles-js"></div>
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold ms-3" href="#">
        <i class="fas fa-satellite-dish me-2 text-info"></i> ONEFIVE <span class="badge bg-danger" style="font-size: 0.7rem;">V1.0</span>
        </a>
        <div class="d-flex me-3">
            <i class="fas fa-bell me-3 align-self-center cursor-pointer"></i>
            <i class="fas fa-cog me-3 align-self-center cursor-pointer"></i>
            <i class="fas fa-user-circle align-self-center cursor-pointer" style="font-size: 1.2rem;"></i>
        </div>
    </div>
</nav>

<div class="sidebar">
    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
        <a class="nav-link" id="v-pills-dashboard-tab" data-bs-toggle="pill" href="#v-pills-dashboard" role="tab" aria-selected="false">
            <i class="fas fa-columns"></i> Dashboard
        </a>
        <a class="nav-link active" id="v-pills-apps-tab" data-bs-toggle="pill" href="#v-pills-apps" role="tab" aria-selected="true">
            <i class="fas fa-th-large"></i> Applications
        </a>
        <a class="nav-link" id="v-pills-processes-tab" data-bs-toggle="pill" href="#v-pills-processes" role="tab" aria-selected="false">
            <i class="fas fa-tasks"></i> Processes
        </a>
        <a class="nav-link" id="v-pills-screenshot-tab" data-bs-toggle="pill" href="#v-pills-screenshot" role="tab" aria-selected="false">
            <i class="fas fa-camera"></i> Screenshot
        </a>
        <a class="nav-link" id="v-pills-keylogger-tab" data-bs-toggle="pill" href="#v-pills-keylogger" role="tab" aria-selected="false">
            <i class="fas fa-keyboard"></i> Keylogger
        </a>
        <a class="nav-link" id="v-pills-webcam-tab" data-bs-toggle="pill" href="#v-pills-webcam" role="tab" aria-selected="false">
            <i class="fas fa-video"></i> Webcam
        </a>
        <a class="nav-link" id="v-pills-power-tab" data-bs-toggle="pill" href="#v-pills-power" role="tab" aria-selected="false">
            <i class="fas fa-power-off"></i> Power
        </a>
        <a class="nav-link" id="v-pills-upload-tab" data-bs-toggle="pill" href="#v-pills-upload" role="tab" aria-selected="false">
            <i class="fas fa-file-upload"></i> File Transfer
        </a>
        <a class="nav-link" id="v-pills-network-tab" data-bs-toggle="pill" href="#v-pills-network" role="tab" aria-selected="false">
            <i class="fas fa-network-wired"></i> Network Monitor
        </a>
    </div>
</div>

<div class="main-content">
    <div class="tab-content" id="v-pills-tabContent">

        <div class="tab-pane fade" id="v-pills-dashboard" role="tabpanel" aria-labelledby="v-pills-dashboard-tab">
            <h2 class="mb-4">Dashboard</h2>
            <div class="card p-4">
                <label for="server-ip-input" class="form-label text-secondary">Nhập địa chỉ IP Server:</label>
                <div class="input-group mb-3">
                    <span class="input-group-text bg-secondary border-secondary text-light">ws://</span>
                    <input type="text" id="server-ip-input" class="form-control" placeholder="192.168.1.x:8080" value="localhost:8080">
                    <button class="btn btn-primary" id="btn-connect">
                        <i class="fas fa-plug me-2"></i> Connect
                    </button>
                </div>
                <hr class="border-secondary my-4">
                <p>Trạng thái: <span id="connection-status" class="badge bg-danger">Disconnected</span></p>
                <p>Lần cuối cập nhật: <span id="last-update">--/--/----, --:--:--</span></p>
            </div>
        </div>

        <div class="tab-pane fade show active" id="v-pills-apps" role="tabpanel" aria-labelledby="v-pills-apps-tab">
            <h2 class="mb-2">Running Applications</h2>
            <p class="text-secondary mb-4">Manage currently running applications on your remote desktop.</p>
            
            <div class="d-flex justify-content-between flex-wrap">
                <div class="d-flex mb-3">
                    <button id="btn-start-app" class="btn btn-primary me-2"><i class="fas fa-plus me-2"></i> Start New Application</button>
                    <button id="refresh-app-list" class="btn btn-outline-secondary"><i class="fas fa-sync-alt me-2"></i> Refresh List</button>
                </div>
                <div class="d-flex mb-3">
                    <div class="input-group" style="max-width: 250px;">
                        <input type="text" id="app-search-input" class="form-control" placeholder="Search...">
                        <span class="input-group-text bg-secondary border-secondary"><i class="fas fa-search text-white"></i></span>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-application">
                    <thead>
                        <tr>
                            <th>APPLICATION NAME</th>
                            <th>PID</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="app-list">
                        <tr><td colspan="4" class="text-center text-secondary">No data received. Click Refresh or check connection.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-pane fade" id="v-pills-processes" role="tabpanel" aria-labelledby="v-pills-processes-tab">
            <h2 class="mb-4">Process Manager</h2>
            <p class="text-secondary">Monitor and manage running processes on the remote machine.</p>
            <div class="card p-4">
                <div class="d-flex justify-content-between flex-wrap mb-3">
                    <div class="btn-group dropend me-2 mb-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter me-2"></i> Sort By
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="#" id="sort-proc-name">Name (A-Z)</a></li>
                            <li><a class="dropdown-item" href="#" id="sort-proc-pid">PID</a></li>
                        </ul>
                    </div>
                    <button id="btn-start-process" class="btn btn-primary mb-2"><i class="fas fa-plus me-2"></i> Launch New Process</button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-application">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>PID</th>
                                <th>CPU</th>
                                <th>Memory</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="process-list">
                            <tr><td colspan="5" class="text-center text-secondary">No data received. Click Refresh or check connection.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="v-pills-screenshot" role="tabpanel" aria-labelledby="v-pills-screenshot-tab">
            <h2 class="mb-4">Screenshot</h2>
            <div class="card p-4">
                <div id="screenshot-placeholder" class="screenshot-placeholder mb-4 text-center">
                    <i class="fas fa-camera fa-4x mb-3 text-secondary"></i>
                    <h5 class="text-secondary">No Screenshot Captured</h5>
                    <p class="text-secondary">Click 'Capture Screenshot' to begin viewing your remote desktop.</p>
                </div>
                <button id="capture-screenshot-btn" class="btn btn-primary btn-lg mb-4 col-md-5 mx-auto">
                    <i class="fas fa-desktop me-2"></i> Capture Screenshot
                </button>
                <div id="latest-capture" class="p-3 mt-4" style="display: none;">
                    <span class="text-secondary me-auto ms-2">Captured: <span id="captured-time">--:--:--</span></span>
                    <img id="screenshot-img" src="" class="img-fluid rounded border border-secondary mt-3" alt="Latest Screenshot">
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="v-pills-keylogger" role="tabpanel" aria-labelledby="v-pills-keylogger-tab">
            <h2 class="mb-4">Keylogger</h2>
            <div class="card p-4">
                <div class="d-flex flex-wrap mb-4">
                    <div class="d-flex gap-3 me-3 mb-2">
                        <button id="start-logging-btn" class="btn btn-success"><i class="fas fa-play me-2"></i> Start Logging </button>
                        <button id="stop-logging-btn" class="btn btn-danger"><i class="fas fa-stop me-2"></i> Stop Logging</button>
                    </div>
                </div>
                <div id="keylogger-log" class="p-3 rounded log-output-box">
                    <p class="text-secondary">[Log activity will be streamed here...]</p>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <p class="mb-0">Status: <span class="text-danger fw-bold" id="log-status">Logging Disabled</span></p>
                    <p class="mb-0">Log entries: <span id="log-count">0</span></p>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="v-pills-webcam" role="tabpanel" aria-labelledby="v-pills-webcam-tab">
            <h2 class="mb-4">Remote Webcam</h2>
            <div class="card p-4">
                <div class="video-container mb-4 position-relative">
                    <div class="d-flex flex-column justify-content-center align-items-center w-100 h-100 position-absolute" style="z-index: 1;">
                        <i class="fas fa-video-slash fa-4x text-secondary mb-3 cursor-pointer"></i>
                        <span class="text-secondary">Video Feed Disabled</span>
                    </div>
                </div>
                <div class="d-flex flex-wrap mb-4">
                    <button id="stream-btn" class="btn btn-primary btn-lg me-3 mb-2">
                        <i class="fas fa-video me-2"></i> <span id="stream-text">Start Stream</span>
                    </button>
                    <button id="record-btn" class="btn btn-outline-danger btn-lg me-3 mb-2">
                        <i class="fas fa-circle me-2"></i> Record Video
                    </button>
                </div>
                <div id="recorded-videos">
                    <div class="p-3 text-center text-secondary">No recorded videos yet.</div>
                </div>
            </div>
        </div>
        
        <div class="tab-pane fade" id="v-pills-power" role="tabpanel" aria-labelledby="v-pills-power-tab">
            <h2 class="mb-4">Critical Actions</h2>
            <p class="text-danger fw-bold">⚠️ Cảnh báo: Các hành động này sẽ ngắt bất kỳ phiên làm việc nào trên máy từ xa.</p>
            <div class="d-grid gap-4 col-md-6 mx-auto mt-5">
                <button id="shutdown-btn" class="btn btn-danger btn-lg py-5 fw-bold power-btn power-action-btn" data-action="shutdown">
                    <i class="fas fa-power-off fa-2x"></i> Shutdown
                </button>
                <button id="restart-btn" class="btn btn-warning btn-lg py-5 text-dark fw-bold power-btn power-action-btn" data-action="restart">
                    <i class="fas fa-redo fa-2x"></i> Restart
                </button>
                <button id="logoff-btn" class="btn btn-secondary btn-lg py-5 fw-bold power-btn power-action-btn" data-action="logoff">
                    <i class="fas fa-sign-out-alt fa-2x"></i> Log Off
                </button>
            </div>
        </div>
        <div class="tab-pane fade" id="v-pills-upload" role="tabpanel" aria-labelledby="v-pills-upload-tab">
            <h2 class="mb-4">File Transfer</h2>
            <div class="card p-5 text-center">
        
                <div class="mb-4">
                    <i class="fas fa-cloud-upload-alt fa-5x text-primary"></i>
                </div>

                <p class="text-secondary mb-4 col-md-8 mx-auto">
                    Chọn file từ máy tính của bạn để gửi. File sẽ được lưu tự động vào thư mục 
                    <span class="text-warning fw-bold"><i class="fas fa-folder-open"></i> Downloads</span> 
                    của máy sever.
                </button>

                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="input-group input-group-lg mb-3">
                            <input type="file" class="form-control" id="file-input">
                            <button class="btn btn-success" type="button" id="btn-upload">
                                <i class="fas fa-paper-plane me-2"></i>Send
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center mt-3">
                    <div class="col-md-8">
                        <div id="upload-status-box" class="alert alert-secondary d-none" role="alert">
                            <i id="upload-icon" class="fas fa-spinner fa-spin me-2"></i> 
                            <span id="upload-msg">Đang xử lý...</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="tab-pane fade" id="v-pills-network" role="tabpanel">
            <h2 class="mb-4">Network Monitor</h2>
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h5 class="card-title">Giám sát kết nối TCP/IP</h5>
                        <small class="text-secondary">Hiển thị các kết nối ra/vào máy trạm theo thời gian thực.</small>
                    </div>
                    <button id="btn-refresh-net" class="btn btn-info">
                        <i class="fas fa-sync-alt me-2"></i> Quét
                    </button>
                </div>

                <div class="table-responsive rounded-4 overflow-hidden shadow-sm border border-secondary">
                    <table class="table table-light table-hover table-striped align-middle text-dark mb-0">
                        <thead class="table-secondary">
                            <tr class="fw-bold text-uppercase small">
                                <th class="py-3 ps-3">Process ID</th> <th class="py-3">Địa chỉ Nguồn</th>
                                <th class="py-3">Địa chỉ Đích</th>
                                <th class="py-3">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="netstat-list" style="font-family: 'Courier New', monospace; font-size: 0.95rem; color: #000 !important;">
                            <tr><td colspan="4" class="text-center text-muted py-4">Chưa có dữ liệu. Bấm nút Quét để xem.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <footer class="mt-5 text-center text-secondary p-4 border-top border-secondary">
    <small>Designed by <b>OneFive</b> © 2025</small><br>
    <small class="text-muted">Secure Connection Established • Encrypted via WebSocket</small>
    </footer>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        // --- KHỞI TẠO WEBSOCKET ---
        let ws = null
        let reconnectTimeout = null;
        let isStreaming = false;
        let globalApps = [];
        let globalProcs = [];
        
        const ipInput = document.getElementById('server-ip-input');
        const connectBtn = document.getElementById('btn-connect');
        const connectionStatus = document.getElementById('connection-status');
        const lastUpdate = document.getElementById('last-update');
        const appListBody = document.getElementById('app-list');
        const processListBody = document.getElementById('process-list');

        if(localStorage.getItem('saved_ip')) {
            ipInput.value = localStorage.getItem('saved_ip');
        }

        connectBtn.addEventListener('click', () => {
            const ip = ipInput.value.trim();
            if(!ip) return alert("Vui lòng nhập IP!");
            localStorage.setItem('saved_ip', ip);
            connectWebSocket(`ws://${ip}/remote`);
        });

        function connectWebSocket(url) {
            if (ws) ws.close();
            connectionStatus.textContent = 'Connecting...';
            connectionStatus.className = 'badge bg-warning text-dark';
            
            try {
                ws = new WebSocket(url);
            } catch(e) {
                alert("IP không hợp lệ!");
                return;
            }

            ws.onopen = () => {
                console.log('Connected!');
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
                setInterval(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        // Ping every 2 seconds to keep connection alive
                        ws.send(JSON.stringify({ type: "PING" }));
                    }
                }, 2000);
                sendCommand({ type: 'GET_APPS' });
                sendCommand({ type: 'PROCESS_LIST' });
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleIncomingData(data);
                    lastUpdate.textContent = new Date().toLocaleTimeString();
                } catch (e) { console.error(e); }
            };

            ws.onclose = () => {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'badge bg-danger';
            };
        }

        function sendCommand(payload) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(payload));
            } else {
                console.error("Socket not connected");
            }
        }
        
        // --- XỬ LÝ DỮ LIỆU ĐẾN ---
        function handleIncomingData(data) {
            switch (data.type) {
                case 'PONG': console.log("Server heartbeat: OK"); break;
                case 'APP_LIST': updateApplicationList(data.payload); break;
                case 'PROCESS_LIST': updateProcessList(data.payload); break;
                case 'SCREENSHOT_DATA': updateScreenshot(data.payload); break;
                case 'KEYLOG_DATA': appendKeylog(data.payload.keyStroke); break;
                case 'WEBCAM_VIDEO': playWebcamVideo(data.payload.base64); break;
                case 'WEBCAM_STATUS': 
                    console.log("Server đang quay: " + data.payload);
                    break;
                case 'UPLOAD_STATUS':
                    const box = document.getElementById('upload-status-box');
                    const msg = document.getElementById('upload-msg');
                    const icon = document.getElementById('upload-icon');
        
                    box.classList.remove('d-none');
                    if (data.payload.status === 'SUCCESS') {
                        box.className = "alert alert-success";
                        msg.innerHTML = `<b>Thành công!</b> File đã được lưu tại Downloads/${data.payload.filename}`;
                        icon.className = "fas fa-check-circle me-2";
                    } else {
                        box.className = "alert alert-danger";
                        msg.textContent = "Thất bại! Server không thể lưu file.";
                        icon.className = "fas fa-times-circle me-2";
                    }
                    break;
                case 'NETSTAT_DATA': renderNetstat(data.payload); break;
            }
        }

        // --- CẬP NHẬT GIAO DIỆN ---

        function updateApplicationList(apps) {
            globalApps = apps || []; 
            renderApps(globalApps);
        }

        function renderApps(appsToRender) {
            let html = '';
            if (!appsToRender || appsToRender.length === 0) {
                html = '<tr><td colspan="4" class="text-center text-secondary">No apps found.</td></tr>';
            } else {
                appsToRender.forEach(app => {
                    const statusClass = app.status === 'Running' ? 'running-badge' : 'notresp-badge';
                    html += `
                        <tr>
                            <td><span class="app-icon-box"><i class="fas fa-window-maximize"></i></span> ${app.name}</td>
                            <td>${app.pid}</td>
                            <td><span class="badge ${statusClass}">${app.status}</span></td>
                            <td><button class="btn btn-kill-app" onclick="requestKill(${app.pid}, '${app.name}')"><i class="fas fa-times-circle"></i></button></td>
                        </tr>
            `       ;
                });
            }
            appListBody.innerHTML = html;
        }

        function updateProcessList(procs) {
            globalProcs = procs || []; 
            renderProcs(globalProcs); 
        }

        function renderProcs(procsToRender) {
            let html = '';
            if (!procsToRender || procsToRender.length === 0) {
                html = '<tr><td colspan="5" class="text-center text-secondary">No processes found.</td></tr>';
            } else {
                procsToRender.forEach(proc => {
                    html += `
                        <tr>
                            <td><i class="fas fa-cog text-secondary me-2"></i> ${proc.name}</td>
                            <td>${proc.pid}</td>
                            <td>${proc.cpu || '0%'}</td>
                            <td>${proc.mem || 'N/A'}</td>
                            <td><button class="btn btn-kill-app btn-sm text-danger" onclick="requestKill(${proc.pid}, '${proc.name}')"><i class="fas fa-times"></i> End Task</button></td>
                        </tr>
            `       ;
                });
            }
            processListBody.innerHTML = html;
        }

        function updateScreenshot(data) {
            if (data && data.base64) {
                document.getElementById('screenshot-img').src = `data:image/png;base64,${data.base64}`;
                document.getElementById('latest-capture').style.display = 'block';
                document.getElementById('screenshot-placeholder').style.display = 'none';
                document.getElementById('captured-time').textContent = new Date().toLocaleTimeString();
            }
        }

        function appendKeylog(key) {
            const logBox = document.getElementById('keylogger-log');
            const p = document.createElement('p');
            p.innerHTML = `[${new Date().toLocaleTimeString()}] ${key}`;
            logBox.prepend(p);
        }
        function playWebcamVideo(base64Str) {
            const videoArea = document.getElementById('recorded-videos');
            if (!videoArea) return;

            videoArea.innerHTML = "";

            const videoObj = document.createElement("video");
            const videoSrc = "data:video/mp4;base64," + base64Str;
            videoObj.src = videoSrc;
            videoObj.controls = true;
            videoObj.autoplay = true;  
            videoObj.muted = true;    
            videoObj.style.width = "100%";
            videoObj.style.borderRadius = "8px";
            videoObj.style.border = "1px solid #444";
    
            videoArea.appendChild(videoObj);

            if (isStreaming) {
                videoObj.controls = false;
                videoObj.onended = function() {
                    console.log(">> Request next stream chunk...");
                    sendCommand({ type: 'RECORD_WEBCAM', payload: { duration: 2 } });
                };
            } else {
                const downloadBtn = document.createElement("a");
                downloadBtn.href = videoSrc;
                downloadBtn.download = "Webcam_" + new Date().getTime() + ".mp4"; 
                downloadBtn.className = "btn btn-success w-100 mt-2";
                downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i> Tải Video Này Về Máy';
        
                videoArea.appendChild(downloadBtn);
            }
        }
        window.requestKill = function(pid, name) {
            if(confirm(`Kill ${name} (PID: ${pid})?`)) {
                sendCommand({ type: 'KILL_APP', payload: { pid: pid } });
            }
        }

        document.getElementById('refresh-app-list').addEventListener('click', () => {
            sendCommand({ type: 'GET_APPS' });
        });

        document.getElementById('btn-start-app').addEventListener('click', () => {
            let name = prompt("Nhập tên ứng dụng hoặc đường dẫn (VD: notepad, calc):");
            if(name) sendCommand({ type: 'START_APP', payload: { path: name } });
        });

        document.getElementById('btn-start-process').addEventListener('click', () => {
            let name = prompt("Nhập tên Process muốn chạy (VD: cmd, explorer):");
            if(name) sendCommand({ type: 'START_APP', payload: { path: name } });
        });

        document.getElementById('capture-screenshot-btn').addEventListener('click', () => {
            sendCommand({ type: 'CAPTURE_SCREEN' });
        });

        const streamBtn = document.getElementById('stream-btn');
        const streamText = document.getElementById('stream-text');

        if (streamBtn) {
            streamBtn.addEventListener('click', () => {
                if (!isStreaming) {
                    isStreaming = true;
            
                    streamBtn.className = "btn btn-danger btn-lg me-3 mb-2"; 
                    streamText.textContent = "Stop Stream";
            
                    console.log(">> Bắt đầu Stream...");
                    sendCommand({ type: 'RECORD_WEBCAM', payload: { duration: 2 } }); 
                } else {
                    isStreaming = false;
            
                    streamBtn.className = "btn btn-primary btn-lg me-3 mb-2";
                    streamText.textContent = "Start Stream";
            
                    console.log(">> Đã dừng Stream.");
                }
            });
        }
        const recordBtn = document.getElementById('record-btn');

        if (recordBtn) {
            recordBtn.addEventListener('click', () => {
                if (isStreaming) {
                    alert("Vui lòng tắt chế độ 'Start Stream' trước khi quay video lẻ!");
                    return;
                }

                let sec = prompt("Nhập số giây muốn quay (VD: 10):", "10");
                sec = parseInt(sec);

                if (isNaN(sec) || sec <= 0 || sec > 60) {
                    return alert("Thời gian không hợp lệ (1-60s)");
                }

                recordBtn.disabled = true;
                const originalText = recordBtn.innerHTML;
                recordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang quay ' + sec + 's...';

                console.log(">> Gửi lệnh quay " + sec + " giây.");
                sendCommand({ type: 'RECORD_WEBCAM', payload: { duration: sec } });

                setTimeout(() => {
                    recordBtn.disabled = false;
                    recordBtn.innerHTML = originalText;
                }, (sec + 2) * 1000);
            });
        }
        document.getElementById('start-logging-btn').addEventListener('click', () => {
            sendCommand({ type: 'KEYLOG_CONTROL', payload: { action: 'START' } });
            document.getElementById('log-status').textContent = "Logging Active";
            document.getElementById('log-status').className = "text-success fw-bold";
        });
        document.getElementById('stop-logging-btn').addEventListener('click', () => {
            sendCommand({ type: 'KEYLOG_CONTROL', payload: { action: 'STOP' } });
            document.getElementById('log-status').textContent = "Logging Paused";
            document.getElementById('log-status').className = "text-danger fw-bold";
        });

        document.querySelectorAll('.power-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.currentTarget.getAttribute('data-action');
                if(confirm(`Bạn có chắc chắn muốn ${action}?`)) {
                    sendCommand({ type: 'SYSTEM_COMMAND', payload: { action: action } });
                }
            });
        });
        const searchInput = document.getElementById('app-search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                const filtered = globalApps.filter(app => 
                    app.name.toLowerCase().includes(keyword) || 
                    app.pid.toString().includes(keyword)
                );
                renderApps(filtered);
            });
        }
        const sortNameBtn = document.getElementById('sort-proc-name');
        const sortPidBtn = document.getElementById('sort-proc-pid');

        if (sortNameBtn) {
            sortNameBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                let sorted = [...globalProcs].sort((a, b) => 
                    a.name.localeCompare(b.name)
                );
                renderProcs(sorted);
            });
        }

        if (sortPidBtn) {
            sortPidBtn.addEventListener('click', (e) => {
                e.preventDefault();
                let sorted = [...globalProcs].sort((a, b) => 
                    a.pid - b.pid
                );
                renderProcs(sorted);
            });
        }
        const btnUpload = document.getElementById('btn-upload');
        const fileInput = document.getElementById('file-input');
        const statusBox = document.getElementById('upload-status-box');
        const statusMsg = document.getElementById('upload-msg');
        const statusIcon = document.getElementById('upload-icon');

        if (btnUpload) {
            btnUpload.addEventListener('click', () => {
                const file = fileInput.files[0];
        
                statusBox.classList.add('d-none');
                statusBox.className = "alert alert-secondary d-none";

                if (!file) {
                    alert("Vui lòng chọn file cần gửi!");
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    alert("File quá lớn! Vui lòng chọn file dưới 10MB.");
                    return;
                }
                statusBox.classList.remove('d-none');
                statusBox.className = "alert alert-warning";
                statusMsg.textContent = "Đang mã hóa và gửi dữ liệu...";
                statusIcon.className = "fas fa-spinner fa-spin me-2";

                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function() {
                    const base64String = reader.result.split(',')[1];

                    sendCommand({
                        type: 'UPLOAD_FILE',
                        payload: {
                            filename: file.name,
                            base64: base64String
                        }
                    });
            
                    statusMsg.textContent = "Đã gửi gói tin lên Server. Đang đợi phản hồi...";
                };

                reader.onerror = function() {
                    statusBox.className = "alert alert-danger";
                    statusMsg.textContent = "Lỗi khi đọc file!";
                    statusIcon.className = "fas fa-exclamation-triangle me-2";
                };
            });
        }
        const btnNet = document.getElementById('btn-refresh-net');
        if (btnNet) {
            btnNet.addEventListener('click', () => {
                const originalText = btnNet.innerHTML;
                btnNet.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang quét...';
                btnNet.disabled = true;

                sendCommand({ type: 'GET_NETSTAT' });

                setTimeout(() => {
                    btnNet.innerHTML = originalText;
                    btnNet.disabled = false;
                }, 1000);
            });
        }

        function renderNetstat(list) {
            const tbody = document.getElementById('netstat-list');
            if (!tbody) return;
    
            let html = '';
            if(list.length === 0) {
                html = '<tr><td colspan="4" class="text-center">Không tìm thấy kết nối nào.</td></tr>';
            } else {
                list.forEach(conn => {
                    let colorClass = "";
                    let icon = "";
            
                    if (conn.state.includes("ESTABLISHED")) {
                        colorClass = "text-success fw-bold";
                        icon = '<i class="fas fa-link me-2"></i>';
                    } else if (conn.state.includes("LISTEN")) {
                        colorClass = "text-warning";
                        icon = '<i class="fas fa-ear-listen me-2"></i>';
                    } else {
                        colorClass = "text-secondary";
                    }
            
                    html += `
                        <tr>
                            <td><span class="badge bg-secondary">${conn.pid}</span></td>
                            <td>${conn.local}</td>
                            <td>${conn.remote}</td>
                            <td class="${colorClass}">${icon}${conn.state}</td>
                        </tr>
            `       ;
                });
            }
            tbody.innerHTML = html;
        }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script>
    particlesJS("particles-js", {
      "particles": {
        "number": {
          "value": 80,
          "density": { "enable": true, "value_area": 800 }
        },
        "color": { "value": "#ffffff" }, // Màu hạt
        "shape": {
          "type": "circle",
          "stroke": { "width": 0, "color": "#000000" }
        },
        "opacity": {
          "value": 0.5,
          "random": false
        },
        "size": {
          "value": 3,
          "random": true
        },
        "line_linked": {
          "enable": true,
          "distance": 150,
          "color": "#ffffff",
          "opacity": 0.4,
          "width": 1
        },
        "move": {
          "enable": true,
          "speed": 3,
          "direction": "none",
          "random": false,
          "straight": false,
          "out_mode": "out",
          "bounce": false
        }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": { "enable": true, "mode": "repulse" },
          "onclick": { "enable": true, "mode": "push" },
          "resize": true
        }
      },
      "retina_detect": true
    });
</script>
</body>
</html>